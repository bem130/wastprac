<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.47.0/min/vs/editor/editor.main.min.css" rel="stylesheet">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.47.0/min/vs/loader.min.js"></script>
        <script src="https://unpkg.com/wabt@1.0.32/index.js"></script>
    </head>
    <body>
        <h1>WebAssembly Playground</h1>
        <div id="input" class="input"></div>
        <button onclick="update()">Run</button>
        <div id="hexviewer" class="output" readonly>
            <table id="wasm"></table>
            <table id="wasm_utf8"></table>
        </div>
        <textarea id="stdout" class="output" readonly></textarea>
    </body>
</html>
<script>

function wasi_fd_write(fd,iovs,iovsLen,nwritten) {
    console.info(`call fd_write: fd=${fd}, iovs=${iovs}, iovsLen=${iovsLen}, nwritten=${nwritten}`)
    const memory = wasi.wasmInstance.exports.memory.buffer;
    const view = new DataView(memory);
    const sizeList = Array.from(Array(iovsLen), (v, i) => {
        const ptr = iovs+i*8;
        const buf = new Uint8Array(memory,view.getUint32(ptr,true),view.getUint32(ptr+4,true));
        const msg = new TextDecoder("utf-8").decode(buf);
        document.getElementById('stdout').value += msg;
        return buf.byteLength;
    })
    const totalSize = sizeList.reduce((acc,v)=>acc+v);
    view.setUint32(nwritten,totalSize,true);
    return 0;
}

function fRead(filename) {
    var hr = new XMLHttpRequest();
    hr.open("GET", filename, false);
    hr.send(null);
    if (hr.status == 200 || hr.status == 304) {
        return hr.responseText.replace(/\r\n/g, "\n");
    }
    else {
        throw "err " + filename;
    }
};
window.onload = ()=>{
    input.setValue(fRead("sample.wat"));
    update();
}

const wasi = {
    wasmInstance: null,
    importObject: {
        wasi_unstable: {
            fd_write: wasi_fd_write,
            proc_exit: () => {},
        }
    }
}

function encodeString(text) {
    return Array.from(new TextEncoder("utf-8").encode(text)).map((x)=>{return "\\"+("0"+x.toString(16)).slice(-2)}).join("");
}

function showHex(elm,data) {
    elm.innerHTML = "";
    {
        const tr = document.createElement("tr");
        elm.appendChild(tr);
        {
            const th = document.createElement("th");
            tr.appendChild(th);
            th.innerText = "adr";
        }
        for (let j=0;j<16;j++) {
            const th = document.createElement("th");
            tr.appendChild(th);
            th.innerText = ("0"+j.toString(16)).slice(-2);
        }
    }
    for (let i=0;i<=data.length/16;i++) {
        const tr = document.createElement("tr");
        elm.appendChild(tr);
        {
            const th = document.createElement("th");
            tr.appendChild(th);
            th.innerText = ("0000"+i.toString(16)+"0").slice(-6);
        }
        for (let j=0;(j<16&&i*16+j<data.length);j++) {
            const td = document.createElement("td");
            tr.appendChild(td);
            td.innerText = ("0"+data[i*16+j].toString(16)).slice(-2);
        }
    }
}
function showHexDecodeUTF8(elm,data) {
    elm.innerHTML = "";
    {
        const tr = document.createElement("tr");
        elm.appendChild(tr);
        for (let j=0;j<16;j++) {
            const th = document.createElement("th");
            tr.appendChild(th);
            th.innerText = ("0"+j.toString(16)).slice(-2);
        }
    }
    for (let i=0;i<=data.length/16;i++) {
        const tr = document.createElement("tr");
        elm.appendChild(tr);
        for (let j=0;(j<16&&i*16+j<data.length);j++) {
            const td = document.createElement("td");
            tr.appendChild(td);
            const ptr = i*16+j;
            td.innerText = utf8toStr(data.slice(ptr,ptr+4));
        }
    }
}

function utf8toStr(data) {
    if ((data[0]>>7)==0b0) {
        return new TextDecoder("utf-8").decode(data.slice(0,1));
    }
    else if ((data[0]>>6)==0b10) {
        return "";
    }
    else if ((data[0]>>5)==0b110) {
        return new TextDecoder("utf-8").decode(data.slice(0,2));
    }
    else if ((data[0]>>4)==0b1110) {
        return new TextDecoder("utf-8").decode(data.slice(0,3));
    }
    else if ((data[0]>>3)==0b11110) {
        return new TextDecoder("utf-8").decode(data.slice(0,4));
    }
    return "";
}

async function main(wast) {
    let wabt = await WabtModule();
    const wasmModule = (()=>{
        try {
            return wabt.parseWat("main.wat", wast);
        }
        catch (err)
        {
            document.getElementById("stdout").value = err.toString();
            throw console.error(err);
        }
    })();
    const { buffer } = wasmModule.toBinary({});
    showHex(document.getElementById('wasm'),buffer);
    showHexDecodeUTF8(document.getElementById('wasm_utf8'),buffer);
    WebAssembly.instantiate(buffer,wasi.importObject).then(res=>{
        console.log(res);
        wasi.wasmInstance=res.instance;
        wasi.wasmInstance.exports._start();
        console.log(new Uint8Array(wasi.wasmInstance.exports.memory.buffer));
        console.log(new Uint32Array(wasi.wasmInstance.exports.memory.buffer));
    }).catch((err)=>{console.error(err);document.getElementById("stdout").value=err.toString()});
}

function update() {
    showHex(document.getElementById('wasm'),[]);
    showHexDecodeUTF8(document.getElementById('wasm_utf8'),[]);
    document.getElementById('stdout').value = "";
    main(input.getValue());
}

require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.47.0/min/vs' } });

require(["vs/editor/editor.main"], function () {

    monaco.languages.register({ id: "wast" });
    monaco.languages.setMonarchTokensProvider("wast", {
        brackets: [
            { token: 'delimiter.parenthesis', open: '(', close: ')' },
        ],
        tokenizer: {
            root: [
                [/[{}()<>\[\]]/, '@brackets'],
                [/"(\\.|[^"\\])*"/, "string"],
                [/'(\\.|[^"\\])*'/, "string"],
                [/0[xX][0-9a-fA-F]+/, 'number'],
                [/\d+/, 'number'],
                [/\$([0-9a-zA-Z]|_)*/, "variable"],
                [/(module|import|export|memory|data|func|call|param|result)/, "keyword"],
                [/(br_if|br|if|then|block|loop)/, "keyword.control"],
                [/(local|global)/, "type"],
                [/(i32|i64|f32|f64)/, "type"],
                [/;;.*/, 'comment'],
            ],
        },
    });
    monaco.editor.defineTheme("myTheme", {
        base: "vs-dark",
        inherit: true,
        rules: [
        ],
        colors: {},
    });

    input = monaco.editor.create(document.querySelector("#input"),{
        language: "wast",
        theme: "myTheme",
        automaticLayout: true,
        wordWrap: false,
        tabSize: 4,
    });
});
</script>
<style>
    body {
        color: white;
        background-color: rgb(0, 29, 54);
    }
    button {
        color: white;
        background-color: rgb(49, 49, 49);
        width: 100px;
        height: 30px;
        border-radius: 10px;
        border: 1px solid gray;
    }
    .input {
        height: calc(40dvh - 80px);
    }
    .output {
        color: white;
        font-family: Consolas, "Courier New", monospace;
        background-color: rgb(30, 30, 30);
        width: calc(100% - 30px);
        height: calc(25dvh);
        outline: none;
        border: none;
        resize: none;
        padding: 10px;
        overflow: auto;
    }
    #hexviewer {
        display: flex;
        & table {
            font-family: Courier, monospace;
            & td {
                padding-right: 3px;
                padding-left: 3px;
            }
            & th {
                color: rgba(255, 255, 255, 0.3);
                user-select: none;
            }
        }
    }
</style>